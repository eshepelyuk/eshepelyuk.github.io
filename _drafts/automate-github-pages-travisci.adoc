---
tags:
- jekyll
- github
- asciidoctor
- travisci
- howto
---
:imagesdir: /assets/images/2014-10-25
= Automate GitHub Pages publishing with Jekyll and Travis CI

Content is a *KING*. Neither fancy _CMS_ nor online _WYSYWIG_ are, but content is.
That's why `Jekyll` powered  `GitHub Pages` got such a popularity.
Just commit `HTML`, `Liquid`, `Markdown` markup etc, then files got processed by `Jekyll` 
and the whole site becomes available online in a minute.
However, if you'd like to use extra `Jekyll` features, for instance `AsciiDoctor`, you should manage `HTML` generation by yourself.
This quite boring activity could be simplified with `Travis CI` project and couple of other tricks that 
I'm going to describe in this post.


== Setting up Jekyll
The only precondition is that you have your `Jekyll` instance properly configured using `Bundler`  and you can run it locally using such a command
`bundle exec jekyll serve`

== Setting up Travis CI

The whole idea was to make process of publishing extended `Jekyll` static site to `GitHub Pages`
as easy as possible - you just push files to `GitHub` and in couple of minutes site is available online.

To achieve this we have to consider the branch approach used by `GitHub Pages`. Please check https://help.github.com/articles/using-jekyll-with-pages/[HERE, window="_blank"]

I'm using _User Pages_ approach so I'd have two branches for my setup
* `master` - where generated content will be stored
* `jekyll` - where markup and configuraiton will be stored

The purpose is to configure `Travis CI` job to listen for commits on `jekyll` branch, then run `Jekyll` build command and push generated content to `master` branch.

=== Enable Hooks
To make `Travis CI` listen for commits - we have to enable hooks. So on each commit `Travis CI` will launch dedicated job.

image::2.png[Enable Travis CI hook]

=== Travis config

Then let's limit commit trigger to `jekyll` branch only and explicitly configure the script that will be executed on each commit.
For this we have to put file `.travis.yml` to the root of `jekyll` branch with following content.
[source,yaml]
.travis.yml
----
language: ruby
script: "./build.sh"
branches:
  only:
  - jekyll
rvm:
- 2.1.2
----

=== Generate and encrypt GitHub token for Travis Ci

image::1.png[Generate GitHub token]
[source,yaml]
----
env:
  global:
    secure: HERE GOES ENCRYPTED STUFF
----

==== Build script

And finally the build script.

[source]
.build.sh
----
#/bin/bash
# enable error reporting to the console
set -e 

# build site with jekyll, by default to `_site' folder
jekyll build

# clone `master' branch to different folder using encrypted `GitHub` token
rm -rf ../eshepelyuk.github.io.master
git clone https://${GH_TOKEN}@github.com/eshepelyuk/eshepelyuk.github.io.git ../eshepelyuk.github.io.master

# copy generated HTML site
cp -R _site/* ../eshepelyuk.github.io.master

# commit and push generated content to `master' branch
cd ../eshepelyuk.github.io.master
git config user.email "eshepelyuk@gmail.com"
git config user.name "Evgeny Shepelyuk"
git add -A .
git commit -a -m "Travis #$TRAVIS_BUILD_NUMBER"
git push origin master
----